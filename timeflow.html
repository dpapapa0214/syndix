<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeFlow - 月間時間割</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="icons/logo-calendarclock.png">
    <link rel="apple-touch-icon" href="icons/logo-calendarclock.png">
    <link rel="manifest" href="manifest/manifesttime.json">
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        
        /* カスタムスクロールバー */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; border: 2px solid #f1f5f9; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* グリッドレイアウトの基本設定（動的に書き換えられます） */
        .timetable-grid {
            display: grid;
            /* 初期値（JSで上書きされます） */
            grid-template-columns: 100px repeat(31, minmax(140px, 1fr));
        }
        
        /* アニメーション */
        .modal-enter { animation: modalPop 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes modalPop {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* 背景パターン */
        .bg-pattern {
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* Today View Timeline Line */
        .timeline-line::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 23px; /* Adjust based on layout */
            width: 2px;
            background-color: #e2e8f0;
            z-index: 0;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden bg-pattern">

    <!-- ヘッダー (Glassmorphism) -->
    <header class="sticky top-0 z-30 bg-white/80 backdrop-blur-md border-b border-slate-200/60 shadow-sm flex-none">
        <div class="max-w-[1920px] mx-auto px-4 sm:px-6 py-3 flex flex-col md:flex-row justify-between items-center gap-4">
            
            <!-- ロゴエリア -->
            <div class="flex items-center gap-3 select-none">
                <div class="bg-gradient-to-br from-indigo-600 to-violet-600 p-2.5 rounded-xl text-white shadow-indigo-200 shadow-lg">
                    <i data-lucide="calendar-clock" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-slate-800 to-slate-600 tracking-tight">TimeFlow</h1>
                    <p class="text-[10px] text-slate-500 font-medium tracking-wider uppercase">Smart Timetable</p>
                </div>
            </div>

            <!-- ビュー切り替え & コントロールエリア -->
            <div class="flex items-center gap-4">
                <!-- ビュー切り替えタブ -->
                <div class="flex bg-slate-100 p-1 rounded-xl border border-slate-200 shadow-inner">
                    <button onclick="switchView('month')" id="tab-month" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-all duration-200 flex items-center gap-2">
                        <i data-lucide="calendar" class="w-4 h-4"></i> 月間
                    </button>
                    <button onclick="switchView('today')" id="tab-today" class="px-4 py-1.5 rounded-lg text-sm font-bold transition-all duration-200 flex items-center gap-2">
                        <i data-lucide="list" class="w-4 h-4"></i> 今日
                    </button>
                </div>

                <!-- 月操作 (月間ビューのみ表示) -->
                <div id="monthControls" class="flex items-center bg-slate-100/80 p-1.5 rounded-2xl border border-slate-200 shadow-inner gap-2">
                    <button onclick="changeMonth(-1)" class="p-2 hover:bg-white text-slate-500 hover:text-slate-800 rounded-xl shadow-sm transition-all duration-200 active:scale-95">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    <div id="currentMonthDisplay" class="font-bold text-lg min-w-[120px] text-center tabular-nums text-slate-700">
                        <!-- JS -->
                    </div>
                    <button onclick="changeMonth(1)" class="p-2 hover:bg-white text-slate-500 hover:text-slate-800 rounded-xl shadow-sm transition-all duration-200 active:scale-95">
                        <i data-lucide="chevron-right" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- 今日の日付 (今日ビューのみ表示) -->
                <div id="todayDateDisplay" class="hidden font-bold text-xl text-slate-800 tracking-tight px-2">
                    <!-- JS -->
                </div>
            </div>

            <!-- アクションボタン群 -->
            <div class="flex gap-2 sm:gap-3">
                <button onclick="openTimeSettingModal()" class="flex items-center gap-2 text-sm font-semibold text-slate-600 bg-white border border-slate-200 hover:bg-slate-50 hover:border-slate-300 px-3 sm:px-4 py-2.5 rounded-xl transition-all shadow-sm">
                    <i data-lucide="clock" class="w-4 h-4"></i>
                    <span class="hidden lg:inline">時間設定</span>
                </button>
                <button onclick="openBulkModal()" class="flex items-center gap-2 text-sm font-semibold text-white bg-slate-800 hover:bg-slate-700 px-3 sm:px-4 py-2.5 rounded-xl transition-all shadow-lg shadow-slate-200 hover:shadow-slate-300 transform active:scale-95">
                    <i data-lucide="wand-2" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">一括登録</span>
                </button>
                
                <div class="w-px h-8 bg-slate-200 mx-1"></div>

                <!-- インポート/エクスポート -->
                <button onclick="exportData()" class="p-2.5 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-colors" title="データを保存 (エクスポート)">
                    <i data-lucide="download-cloud" class="w-5 h-5"></i>
                </button>
                <button onclick="triggerImport()" class="p-2.5 text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-colors" title="データを読み込み (インポート)">
                    <i data-lucide="upload-cloud" class="w-5 h-5"></i>
                </button>
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importData(this)">

                <button onclick="clearCurrentMonth()" class="p-2.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-colors" title="今月のデータを削除">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="flex-1 overflow-hidden relative">
        <!-- 月間ビュー -->
        <div id="monthViewWrapper" class="h-full overflow-auto fade-in">
            <div class="min-w-max p-6 pb-32">
                <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden">
                    <!-- テーブルヘッダー (日付軸) -->
                    <div id="gridHeader" class="sticky top-0 z-20 timetable-grid bg-slate-50/95 backdrop-blur-sm border-b border-slate-200">
                        <!-- JSで描画 -->
                    </div>
                    <!-- テーブルボディ (時限軸) -->
                    <div id="gridBody" class="divide-y divide-slate-100">
                        <!-- JSで描画 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 今日ビュー -->
        <div id="todayViewWrapper" class="h-full overflow-y-auto hidden fade-in bg-white/50">
            <div class="max-w-3xl mx-auto p-4 sm:p-8 pb-32">
                
                <!-- 今日のヘッダー情報 -->
                <div class="mb-8 text-center sm:text-left">
                    <h2 class="text-3xl font-bold text-slate-800 mb-2">Today's Schedule</h2>
                    <p class="text-slate-500 flex items-center justify-center sm:justify-start gap-2">
                        <i data-lucide="check-circle-2" class="w-4 h-4 text-emerald-500"></i>
                        <span id="todayStatusMessage">今日は素晴らしい一日になりそうです！</span>
                    </p>
                </div>

                <!-- タイムライン -->
                <div id="todayTimeline" class="relative timeline-line space-y-6">
                    <!-- JSで描画 -->
                </div>
                
                <!-- 空の状態 -->
                <div id="todayEmptyState" class="hidden flex flex-col items-center justify-center py-20 text-center">
                    <div class="bg-slate-100 p-4 rounded-full mb-4">
                        <i data-lucide="coffee" class="w-8 h-8 text-slate-400"></i>
                    </div>
                    <h3 class="text-lg font-bold text-slate-700">今日の予定はありません</h3>
                    <p class="text-slate-500 mt-1">ゆっくり休みましょう</p>
                </div>
            </div>
        </div>
    </main>

    <!-- オーバーレイ (共通) -->
    <div id="overlay" class="hidden fixed inset-0 z-40 bg-slate-900/20 backdrop-blur-[2px] transition-opacity duration-300 opacity-0" aria-hidden="true"></div>

    <!-- 編集モーダル -->
    <div id="editModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm pointer-events-auto transform transition-all scale-95 opacity-0 border border-slate-100" id="editModalContent">
            
            <!-- ヘッダー -->
            <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 rounded-t-3xl">
                <div>
                    <h3 id="modalTitle" class="font-bold text-lg text-slate-800">授業編集</h3>
                    <p id="modalSubtitle" class="text-xs text-slate-500 font-medium mt-0.5">詳細を入力してください</p>
                </div>
                <button onclick="closeModal('editModal')" class="text-slate-400 hover:text-slate-600 p-2 hover:bg-slate-100 rounded-full transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- ボディ -->
            <div class="p-6 space-y-5">
                <div class="space-y-1.5">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider pl-1">科目名</label>
                    <div class="relative">
                        <i data-lucide="book-open" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
                        <input id="inputSubject" class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all placeholder:text-slate-300" placeholder="例: 数学II">
                    </div>
                </div>
                
                <div class="space-y-1.5">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider pl-1">教室 / メモ</label>
                    <div class="relative">
                        <i data-lucide="map-pin" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
                        <input id="inputRoom" class="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none transition-all placeholder:text-slate-300" placeholder="例: 3-A">
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider pl-1">カラーラベル</label>
                    <div id="colorPicker" class="flex flex-wrap gap-2.5">
                        <!-- JSで描画 -->
                    </div>
                </div>
            </div>

            <!-- フッター -->
            <div class="px-6 py-4 bg-slate-50/80 border-t border-slate-100 flex justify-between rounded-b-3xl">
                <button onclick="deleteCell()" class="text-red-500 hover:text-red-600 hover:bg-red-50 px-4 py-2.5 rounded-xl text-sm font-medium transition-colors flex items-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> 削除
                </button>
                <button onclick="saveCell()" class="bg-slate-800 text-white hover:bg-slate-700 px-6 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-slate-200 hover:shadow-slate-300 transition-all transform active:scale-95 flex items-center gap-2">
                    <i data-lucide="check" class="w-4 h-4"></i> 保存
                </button>
            </div>
        </div>
    </div>

    <!-- 一括登録モーダル -->
    <div id="bulkModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg pointer-events-auto transform transition-all scale-95 opacity-0 border border-slate-100" id="bulkModalContent">
            <div class="px-6 py-5 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white flex justify-between items-center rounded-t-3xl">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-100 text-indigo-600 p-2 rounded-lg">
                        <i data-lucide="wand-2" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg text-slate-800">一括自動登録</h3>
                        <p class="text-xs text-slate-500">複数時限・複数曜日の一括設定が可能です</p>
                    </div>
                </div>
                <button onclick="closeModal('bulkModal')" class="text-slate-400 hover:text-slate-600 p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
                <!-- 期間設定 -->
                <div class="space-y-1.5 bg-slate-50 p-3 rounded-xl border border-slate-200">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1">
                        <i data-lucide="calendar-range" class="w-3 h-3"></i> 期間設定
                    </label>
                    <div class="flex items-center gap-2">
                        <input type="date" id="bulkStartDate" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none">
                        <span class="text-slate-400">～</span>
                        <input type="date" id="bulkEndDate" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">対象の時限 (複数選択可)</label>
                        <div id="bulkPeriodSelector" class="grid grid-cols-4 gap-2">
                            <!-- JSで生成 -->
                        </div>
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">適用ルール</label>
                        <div class="relative">
                            <select id="bulkRule" onchange="toggleSpecificDay()" class="w-full appearance-none pl-4 pr-10 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-indigo-500/20 outline-none cursor-pointer">
                                <option value="everyday">毎日</option>
                                <option value="even">偶数日 (2,4...)</option>
                                <option value="odd">奇数日 (1,3...)</option>
                                <option value="multiple3">3の倍数日</option>
                                <option value="specificDay">特定の曜日</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-3 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                </div>

                <div id="specificDaySelector" class="hidden bg-slate-50 p-4 rounded-2xl border border-slate-200 animate-in fade-in slide-in-from-top-2">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3 block">曜日を選択 (複数選択可)</label>
                    <div class="flex justify-between" id="bulkDayButtons">
                        <!-- JS -->
                    </div>
                </div>

                <div class="space-y-4 pt-2 border-t border-slate-100">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider pl-1">科目名</label>
                            <input id="bulkSubject" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none placeholder:text-slate-300" placeholder="例: 英語表現">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-wider pl-1">教室</label>
                            <input id="bulkRoom" class="w-full px-4 py-2.5 border border-slate-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 outline-none placeholder:text-slate-300" placeholder="例: LL教室">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider pl-1">カラーラベル</label>
                        <div id="bulkColorPicker" class="flex flex-wrap gap-2.5">
                            <!-- JS -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 bg-slate-50/80 border-t border-slate-100 flex justify-end gap-3 rounded-b-3xl">
                <button onclick="closeModal('bulkModal')" class="px-5 py-2.5 text-sm font-semibold text-slate-600 hover:bg-slate-200 rounded-xl transition-colors">キャンセル</button>
                <button onclick="applyBulkRule()" class="px-6 py-2.5 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded-xl shadow-lg shadow-indigo-200 hover:shadow-indigo-300 transition-all transform active:scale-95 flex items-center gap-2">
                    <i data-lucide="zap" class="w-4 h-4"></i> 実行
                </button>
            </div>
        </div>
    </div>

    <!-- 時間設定モーダル -->
    <div id="timeSettingModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md pointer-events-auto transform transition-all scale-95 opacity-0 border border-slate-100 flex flex-col max-h-[85vh]" id="timeSettingModalContent">
            <div class="px-6 py-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center rounded-t-3xl flex-none">
                <div class="flex items-center gap-2">
                    <i data-lucide="clock" class="w-5 h-5 text-slate-500"></i>
                    <h3 class="font-bold text-lg text-slate-800">時間割設定</h3>
                </div>
                <button onclick="closeModal('timeSettingModal')" class="text-slate-400 hover:text-slate-600 p-2 hover:bg-slate-100 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1 custom-scrollbar">
                <div id="timeInputsContainer" class="space-y-3">
                    <!-- JS -->
                </div>
            </div>
            
            <div class="px-6 py-4 bg-slate-50/80 border-t border-slate-100 flex justify-end gap-3 rounded-b-3xl flex-none">
                 <button onclick="closeModal('timeSettingModal')" class="px-5 py-2.5 text-sm font-semibold text-slate-600 hover:bg-slate-200 rounded-xl transition-colors">キャンセル</button>
                <button onclick="saveTimeSettings()" class="bg-slate-800 text-white hover:bg-slate-700 px-6 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-slate-200 hover:shadow-slate-300 transition-all active:scale-95">設定を保存</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // --- 設定・定数 ---
        const periods = [0, ...Array.from({length: 12}, (_, i) => i + 1)];

        // カラーパレット (Tailwind classes)
        const colors = [
            { name: 'スレート', value: 'bg-slate-100', text: 'text-slate-700', hover: 'hover:bg-slate-200', border: 'border-slate-200', ring: 'ring-slate-300', dot: 'bg-slate-500' },
            { name: 'ローズ',   value: 'bg-rose-100',   text: 'text-rose-800',   hover: 'hover:bg-rose-200',   border: 'border-rose-200',   ring: 'ring-rose-300', dot: 'bg-rose-500' },
            { name: 'オレンジ', value: 'bg-orange-100', text: 'text-orange-800', hover: 'hover:bg-orange-200', border: 'border-orange-200', ring: 'ring-orange-300', dot: 'bg-orange-500' },
            { name: 'アンバー', value: 'bg-amber-100',  text: 'text-amber-800',  hover: 'hover:bg-amber-200',  border: 'border-amber-200',  ring: 'ring-amber-300', dot: 'bg-amber-500' },
            { name: 'エメラルド', value: 'bg-emerald-100', text: 'text-emerald-800', hover: 'hover:bg-emerald-200', border: 'border-emerald-200', ring: 'ring-emerald-300', dot: 'bg-emerald-500' },
            { name: 'シアン',   value: 'bg-cyan-100',   text: 'text-cyan-800',   hover: 'hover:bg-cyan-200',   border: 'border-cyan-200',   ring: 'ring-cyan-300', dot: 'bg-cyan-500' },
            { name: 'インディゴ', value: 'bg-indigo-100', text: 'text-indigo-800', hover: 'hover:bg-indigo-200', border: 'border-indigo-200', ring: 'ring-indigo-300', dot: 'bg-indigo-500' },
            { name: 'バイオレット', value: 'bg-violet-100', text: 'text-violet-800', hover: 'hover:bg-violet-200', border: 'border-violet-200', ring: 'ring-violet-300', dot: 'bg-violet-500' },
            { name: 'フクシア', value: 'bg-fuchsia-100', text: 'text-fuchsia-800', hover: 'hover:bg-fuchsia-200', border: 'border-fuchsia-200', ring: 'ring-fuchsia-300', dot: 'bg-fuchsia-500' },
        ];

        // デフォルトの時間設定
        const defaultTimeSettings = {
            0: { start: '', end: '' },
            1: { start: '09:00', end: '10:30' },
            2: { start: '10:40', end: '12:10' },
            3: { start: '13:00', end: '14:30' },
            4: { start: '14:40', end: '16:10' },
            5: { start: '16:20', end: '17:50' },
            6: { start: '18:00', end: '19:30' },
            7: { start: '19:40', end: '21:10' },
            8: { start: '21:20', end: '22:50' },
            9: { start: '', end: '' },
            10: { start: '', end: '' },
            11: { start: '', end: '' },
            12: { start: '', end: '' },
        };

        // --- 状態変数 ---
        let currentDate = new Date();
        let currentView = 'month'; // 'month' or 'today'
        let schedule = {}; 
        let timeSettings = { ...defaultTimeSettings };

        let selectedCell = null;
        let selectedColorIndex = 0;
        let bulkColorIndex = 0;
        let bulkSelectedPeriods = new Set([1]); // デフォルト1限
        let bulkSelectedDays = new Set([1]);    // デフォルト月曜

        // --- 初期化 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            renderApp();
            
            setupColorPickers();
            setupBulkSelectors();
        });

        // --- インポート・エクスポート機能 ---
        function exportData() {
            const data = {
                schedule: schedule,
                timeSettings: timeSettings,
                exportDate: new Date().toISOString(),
                version: "2.0"
            };
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `timeflow_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function triggerImport() {
            document.getElementById('importFile').click();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.schedule && data.timeSettings) {
                        schedule = data.schedule;
                        timeSettings = data.timeSettings;
                        saveData();
                        saveTimeSettingsData();
                        renderApp();
                        alert('データを復元しました。');
                    } else {
                        alert('無効なデータ形式です。');
                    }
                } catch (err) {
                    alert('ファイルの読み込みに失敗しました。');
                    console.error(err);
                }
                // inputをリセット
                input.value = '';
            };
            reader.readAsText(file);
        }

        // --- データ操作 ---
        function loadData() {
            const savedSchedule = localStorage.getItem('timetable-calendar-data-v2');
            if (savedSchedule) {
                schedule = JSON.parse(savedSchedule);
            } else {
                const oldData = localStorage.getItem('timetable-calendar-data');
                if (oldData) schedule = JSON.parse(oldData);
            }

            const savedTimes = localStorage.getItem('timetable-time-settings-v2');
            if (savedTimes) {
                timeSettings = JSON.parse(savedTimes);
            } else {
                const oldTimes = localStorage.getItem('timetable-time-settings');
                if (oldTimes) timeSettings = { ...defaultTimeSettings, ...JSON.parse(oldTimes) };
            }
        }

        function saveData() {
            localStorage.setItem('timetable-calendar-data-v2', JSON.stringify(schedule));
        }

        function saveTimeSettingsData() {
            localStorage.setItem('timetable-time-settings-v2', JSON.stringify(timeSettings));
        }

        // --- ビュー切り替え ---
        function switchView(view) {
            currentView = view;
            
            // タブスタイルの更新
            const monthTab = document.getElementById('tab-month');
            const todayTab = document.getElementById('tab-today');
            const activeClass = 'bg-white shadow-sm text-indigo-600';
            const inactiveClass = 'text-slate-500 hover:text-slate-700 hover:bg-slate-200/50';

            if (view === 'month') {
                monthTab.className = `px-4 py-1.5 rounded-lg text-sm font-bold transition-all duration-200 flex items-center gap-2 ${activeClass}`;
                todayTab.className = `px-4 py-1.5 rounded-lg text-sm font-bold transition-all duration-200 flex items-center gap-2 ${inactiveClass}`;
                
                document.getElementById('monthViewWrapper').classList.remove('hidden');
                document.getElementById('todayViewWrapper').classList.add('hidden');
                document.getElementById('monthControls').classList.remove('hidden');
                document.getElementById('todayDateDisplay').classList.add('hidden');
            } else {
                monthTab.className = `px-4 py-1.5 rounded-lg text-sm font-bold transition-all duration-200 flex items-center gap-2 ${inactiveClass}`;
                todayTab.className = `px-4 py-1.5 rounded-lg text-sm font-bold transition-all duration-200 flex items-center gap-2 ${activeClass}`;
                
                document.getElementById('monthViewWrapper').classList.add('hidden');
                document.getElementById('todayViewWrapper').classList.remove('hidden');
                document.getElementById('monthControls').classList.add('hidden');
                document.getElementById('todayDateDisplay').classList.remove('hidden');
                
                renderTodayView(); // Todayビューの再描画
            }
        }

        // --- レンダリング ---
        function renderApp() {
            renderHeader();
            if (currentView === 'month') {
                renderGrid();
            } else {
                renderTodayView();
            }
            switchView(currentView); // 状態をUIに反映
            lucide.createIcons();
        }

        function renderHeader() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            document.getElementById('currentMonthDisplay').textContent = `${year}.${String(month).padStart(2, '0')}`;
            
            // 今日の日付表示
            const today = new Date();
            const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
            document.getElementById('todayDateDisplay').textContent = `${today.getMonth()+1}/${today.getDate()} (${dayNames[today.getDay()]})`;
        }

        // --- Todayビューのレンダリング ---
        function renderTodayView() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            const date = today.getDate();
            const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
            const fullDateKey = `${year}-${String(month).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
            
            const timelineContainer = document.getElementById('todayTimeline');
            const emptyState = document.getElementById('todayEmptyState');
            let html = '';
            let hasClasses = false;
            
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();

            periods.forEach(p => {
                const key = `${fullDateKey}-${p}`;
                const cell = schedule[key];
                
                if (cell && cell.subject) {
                    hasClasses = true;
                    const time = timeSettings[p] || { start: '--:--', end: '--:--' };
                    const colorStyle = colors[cell.color];
                    
                    let isActive = false;
                    let isPast = false;
                    if (time.start && time.end) {
                        const [sH, sM] = time.start.split(':').map(Number);
                        const [eH, eM] = time.end.split(':').map(Number);
                        const startMin = sH * 60 + sM;
                        const endMin = eH * 60 + eM;
                        if (currentMinutes >= startMin && currentMinutes <= endMin) {
                            isActive = true;
                        } else if (currentMinutes > endMin) {
                            isPast = true;
                        }
                    }

                    const cardClass = isActive 
                        ? 'ring-2 ring-indigo-500 shadow-lg scale-[1.02] bg-white' 
                        : isPast 
                            ? 'opacity-60 bg-slate-50 grayscale-[0.5]' 
                            : 'bg-white shadow-sm hover:shadow-md hover:scale-[1.01]';

                    const dotClass = isActive ? 'animate-pulse' : '';

                    html += `
                        <div class="relative pl-12 sm:pl-16 py-1 group cursor-pointer" onclick="openEditModal('${key}', '${fullDateKey}', '${month}月${date}日(${dayNames[today.getDay()]})', ${p})">
                            <div class="absolute left-[16px] top-1/2 -translate-y-1/2 w-4 h-4 rounded-full border-[3px] border-white shadow-sm z-10 ${colorStyle.dot} ${dotClass}"></div>
                            <div class="absolute left-0 top-0 text-[10px] font-mono text-slate-400 font-bold -translate-x-full pr-4 text-right w-16 pt-3 sm:pt-4">
                                <div>${time.start}</div>
                                <div class="opacity-50">${time.end}</div>
                            </div>
                            <div class="rounded-xl p-4 border border-slate-100 transition-all duration-300 ${cardClass}">
                                <div class="flex justify-between items-start gap-2">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider ${colorStyle.value} ${colorStyle.text} border ${colorStyle.border}">
                                                ${p} Period
                                            </span>
                                            ${isActive ? '<span class="text-[10px] font-bold text-indigo-600 flex items-center gap-1"><i data-lucide="activity" class="w-3 h-3"></i> NOW</span>' : ''}
                                        </div>
                                        <h3 class="font-bold text-lg text-slate-800 leading-tight">${escapeHtml(cell.subject)}</h3>
                                        ${cell.room ? `
                                            <div class="flex items-center gap-1.5 mt-2 text-sm text-slate-500 font-medium">
                                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                                ${escapeHtml(cell.room)}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                                        <div class="p-2 rounded-full hover:bg-slate-100 text-slate-400">
                                            <i data-lucide="pencil" class="w-4 h-4"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            if (hasClasses) {
                timelineContainer.innerHTML = html;
                emptyState.classList.add('hidden');
                document.getElementById('todayStatusMessage').textContent = '今日のスケジュールです。頑張りましょう！';
            } else {
                timelineContainer.innerHTML = '';
                emptyState.classList.remove('hidden');
                document.getElementById('todayStatusMessage').textContent = '今日の予定は登録されていません。';
            }
            lucide.createIcons();
        }

        // --- 月間ビューのレンダリング ---
        function renderGrid() {
            const gridHeader = document.getElementById('gridHeader');
            const gridBody = document.getElementById('gridBody');
            const daysInMonth = getDaysInMonth(currentDate);
            
            // 列定義を更新: [時限列 100px] + [日付列数 * 140px]
            const gridTemplate = `grid-template-columns: 100px repeat(${daysInMonth.length}, minmax(140px, 1fr))`;
            gridHeader.style = gridTemplate;

            // ヘッダー生成 (横軸: 日付)
            // 左上の角（時限/日付の交点）は固定
            let headerHTML = `<div class="p-3 text-xs font-bold text-slate-400 uppercase tracking-wider text-center border-r border-slate-200 flex items-center justify-center bg-slate-50 sticky left-0 z-20 shadow-[4px_0_5px_-2px_rgba(0,0,0,0.05)]">Period</div>`;
            
            daysInMonth.forEach(dayObj => {
                const isToday = isDateToday(dayObj);
                const isWeekend = dayObj.dayIndex === 0 || dayObj.dayIndex === 6;
                const isSun = dayObj.dayIndex === 0;
                const isSat = dayObj.dayIndex === 6;
                
                const dateColor = isToday ? 'text-indigo-600 bg-indigo-50 rounded-lg px-2 py-1' 
                                : isSun ? 'text-rose-500' 
                                : isSat ? 'text-blue-500' 
                                : 'text-slate-700';
                
                const borderClass = isToday ? 'border-indigo-200' : 'border-slate-200';

                headerHTML += `
                    <div class="p-2 text-center border-r ${borderClass} last:border-r-0 flex flex-col justify-center min-h-[50px] group hover:bg-slate-50 transition-colors">
                        <span class="text-sm font-bold ${dateColor} inline-block">${dayObj.date} <span class="text-xs font-normal opacity-75">(${dayObj.day})</span></span>
                    </div>
                `;
            });
            gridHeader.innerHTML = headerHTML;

            // ボディ生成 (縦軸: 時限)
            let bodyHTML = '';

            periods.forEach(p => {
                const time = timeSettings[p] || { start: '--:--', end: '--:--' };
                
                // 行コンテナ (Grid)
                bodyHTML += `
                    <div class="timetable-grid hover:bg-slate-50/30 transition-colors border-b border-slate-100 last:border-b-0" style="${gridTemplate}">
                        <!-- 左端: 時限ラベル (固定) -->
                        <div class="p-3 border-r border-slate-200 flex flex-col justify-center items-center bg-white sticky left-0 z-10 shadow-[4px_0_5px_-2px_rgba(0,0,0,0.05)]">
                            <span class="text-lg font-bold text-slate-800">${p}</span>
                            <span class="text-[10px] font-mono text-slate-400 mt-1 leading-tight text-center">${time.start}<br>|<br>${time.end}</span>
                        </div>
                `;

                // 各日付のセル
                daysInMonth.forEach(dayObj => {
                    const key = `${dayObj.fullDateKey}-${p}`;
                    const cell = schedule[key] || { subject: '', room: '', color: 0 };
                    const colorStyle = colors[cell.color];
                    const hasData = !!cell.subject;
                    const isWeekend = dayObj.dayIndex === 0 || dayObj.dayIndex === 6;
                    
                    const cellInnerClass = hasData 
                        ? `${colorStyle.value} ${colorStyle.text} border ${colorStyle.border} shadow-sm` 
                        : `border border-dashed border-slate-200 hover:border-indigo-300 hover:bg-indigo-50/30 text-slate-300`;

                    const bgClass = !hasData && isWeekend ? 'bg-slate-50/40' : '';

                    let content = '';
                    if (hasData) {
                        content = `
                            <div class="h-full flex flex-col justify-between">
                                <div class="font-bold text-sm leading-tight line-clamp-2">${escapeHtml(cell.subject)}</div>
                                ${cell.room ? `
                                    <div class="flex items-center gap-1 mt-1 text-[10px] opacity-80 font-medium">
                                        <i data-lucide="map-pin" class="w-3 h-3"></i>
                                        <span class="truncate">${escapeHtml(cell.room)}</span>
                                    </div>` : ''}
                            </div>
                        `;
                    } else {
                        content = `
                            <div class="w-full h-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <i data-lucide="plus" class="w-4 h-4 text-indigo-300"></i>
                            </div>
                        `;
                    }

                    const dateStr = dayObj.fullDateKey;
                    const dayDisplay = `${dayObj.date}日 (${dayObj.day})`;
                    
                    bodyHTML += `
                        <div class="p-1.5 border-r border-slate-100 last:border-r-0 h-28 relative group cursor-pointer ${bgClass}"
                             onclick="openEditModal('${key}', '${dateStr}', '${dayDisplay}', ${p})">
                            <div class="w-full h-full rounded-lg p-2 transition-all duration-200 ${cellInnerClass}">
                                ${content}
                            </div>
                        </div>
                    `;
                });

                bodyHTML += `</div>`;
            });

            gridBody.innerHTML = bodyHTML;
        }

        // --- ユーティリティ ---
        function getDaysInMonth(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const days = [];
            const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
            const dayNamesEn = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            for (let i = 1; i <= daysInMonth; i++) {
                const d = new Date(year, month, i);
                days.push({
                    date: i,
                    day: dayNames[d.getDay()],
                    dayEn: dayNamesEn[d.getDay()],
                    dayIndex: d.getDay(),
                    fullDateKey: `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`
                });
            }
            return days;
        }

        function isDateToday(dayObj) {
            const today = new Date();
            return today.getDate() === dayObj.date && 
                   today.getMonth() === currentDate.getMonth() && 
                   today.getFullYear() === currentDate.getFullYear();
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderApp();
        }

        function clearCurrentMonth() {
            if (confirm(`${currentDate.getMonth() + 1}月のデータを全て削除しますか？\nこの操作は取り消せません。`)) {
                const days = getDaysInMonth(currentDate);
                days.forEach(day => {
                    periods.forEach(p => {
                        delete schedule[`${day.fullDateKey}-${p}`];
                    });
                });
                saveData();
                renderApp();
            }
        }

        // --- モーダル共通処理 ---
        function showOverlay() {
            const overlay = document.getElementById('overlay');
            overlay.classList.remove('hidden');
            void overlay.offsetWidth; 
            overlay.classList.add('opacity-100');
        }

        function hideOverlay() {
            const overlay = document.getElementById('overlay');
            overlay.classList.remove('opacity-100');
            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 300);
        }

        function openModalAnimation(modalId, contentId) {
            showOverlay();
            const modal = document.getElementById(modalId);
            const content = document.getElementById(contentId);
            modal.classList.remove('hidden');
            void content.offsetWidth;
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }

        function closeModal(modalId) {
            hideOverlay();
            const modal = document.getElementById(modalId);
            const content = modal.querySelector('div[id$="Content"]');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        // --- 編集モーダル ---
        function openEditModal(key, dateStr, dayDisplay, period) {
            const cell = schedule[key] || { subject: '', room: '', color: 0 };
            selectedCell = { key, dateStr, dayDisplay, period };
            
            document.getElementById('modalTitle').textContent = `${dayDisplay} - ${period}限`;
            document.getElementById('modalSubtitle').textContent = schedule[key] ? '内容を編集します' : '新しい予定を追加';
            
            document.getElementById('inputSubject').value = cell.subject;
            document.getElementById('inputRoom').value = cell.room;
            selectColor(cell.color);
            
            openModalAnimation('editModal', 'editModalContent');
            setTimeout(() => document.getElementById('inputSubject').focus(), 100);
        }

        function setupColorPickers() {
            const container = document.getElementById('colorPicker');
            const bulkContainer = document.getElementById('bulkColorPicker');
            const createButtons = (targetContainer, isBulk) => {
                let html = '';
                colors.forEach((c, index) => {
                    html += `
                        <button onclick="${isBulk ? 'selectBulkColor' : 'selectColor'}(${index})" 
                            id="${isBulk ? 'bulk-color-' : 'color-'}${index}"
                            class="w-8 h-8 rounded-full border-2 transition-all duration-200 focus:outline-none ${c.value} border-transparent hover:scale-110"
                            title="${c.name}">
                            <div class="w-full h-full rounded-full flex items-center justify-center opacity-0 transition-opacity check-icon">
                                <i data-lucide="check" class="w-4 h-4 ${c.text}"></i>
                            </div>
                        </button>
                    `;
                });
                targetContainer.innerHTML = html;
            };
            createButtons(container, false);
            createButtons(bulkContainer, true);
        }

        function selectColor(index) {
            selectedColorIndex = index;
            updateColorSelection('color-', index);
        }
        
        function selectBulkColor(index) {
            bulkColorIndex = index;
            updateColorSelection('bulk-color-', index);
        }

        function updateColorSelection(prefix, selectedIndex) {
            colors.forEach((c, i) => {
                const btn = document.getElementById(prefix + i);
                const check = btn.querySelector('.check-icon');
                if (i === selectedIndex) {
                    btn.classList.add('scale-110', c.ring, 'ring-2', 'ring-offset-2');
                    btn.classList.remove('border-transparent');
                    check.classList.remove('opacity-0');
                } else {
                    btn.classList.remove('scale-110', c.ring, 'ring-2', 'ring-offset-2');
                    btn.classList.add('border-transparent');
                    check.classList.add('opacity-0');
                }
            });
        }

        function saveCell() {
            if (!selectedCell) return;
            const subject = document.getElementById('inputSubject').value;
            const room = document.getElementById('inputRoom').value;
            if (subject) {
                schedule[selectedCell.key] = { subject, room, color: selectedColorIndex };
            } else {
                delete schedule[selectedCell.key];
            }
            saveData();
            closeModal('editModal');
            if(currentView === 'today') renderTodayView();
            else renderGrid();
        }

        function deleteCell() {
            if (selectedCell) {
                delete schedule[selectedCell.key];
                saveData();
                closeModal('editModal');
                if(currentView === 'today') renderTodayView();
                else renderGrid();
            }
        }

        // --- 時間設定モーダル ---
        function openTimeSettingModal() {
            const container = document.getElementById('timeInputsContainer');
            let html = '';
            periods.forEach(p => {
                const time = timeSettings[p] || { start: '', end: '' };
                html += `
                    <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-2xl border border-slate-100 hover:border-slate-200 transition-colors">
                        <div class="font-bold text-slate-500 w-12 text-center text-sm">
                            <span class="text-lg text-slate-800">${p}</span> 限
                        </div>
                        <div class="flex items-center gap-3 flex-1">
                            <input type="time" id="time-start-${p}" value="${time.start}" class="w-full px-3 py-2 border border-slate-200 rounded-xl text-sm font-medium bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none">
                            <span class="text-slate-300 font-bold">-</span>
                            <input type="time" id="time-end-${p}" value="${time.end}" class="w-full px-3 py-2 border border-slate-200 rounded-xl text-sm font-medium bg-white focus:ring-2 focus:ring-indigo-500/20 outline-none">
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            openModalAnimation('timeSettingModal', 'timeSettingModalContent');
        }

        function saveTimeSettings() {
            periods.forEach(p => {
                const start = document.getElementById(`time-start-${p}`).value;
                const end = document.getElementById(`time-end-${p}`).value;
                timeSettings[p] = { start, end };
            });
            saveTimeSettingsData();
            closeModal('timeSettingModal');
            renderApp();
        }

        // --- 一括登録モーダル ---
        function setupBulkSelectors() {
            // 時限セレクタ（複数選択）
            const periodContainer = document.getElementById('bulkPeriodSelector');
            let periodHtml = '';
            periods.forEach(p => {
                periodHtml += `
                    <button onclick="toggleBulkPeriod(${p})" id="bulk-period-btn-${p}" 
                        class="px-2 py-2 rounded-lg text-xs font-bold transition-all border border-slate-200 hover:bg-slate-50 bg-white text-slate-600 flex items-center justify-center">
                        ${p}限
                    </button>`;
            });
            periodContainer.innerHTML = periodHtml;

            // 曜日セレクタ（複数選択）
            const days = ['日','月','火','水','木','金','土'];
            const dayContainer = document.getElementById('bulkDayButtons');
            let dayHtml = '';
            days.forEach((d, i) => {
                dayHtml += `
                    <button onclick="toggleBulkDay(${i})" id="bulk-day-${i}" 
                        class="w-9 h-9 rounded-full text-xs font-bold transition-all border border-slate-200 hover:bg-slate-100 bg-white text-slate-500 flex items-center justify-center">
                        ${d}
                    </button>`;
            });
            dayContainer.innerHTML = dayHtml;
        }

        function openBulkModal() {
            document.getElementById('bulkSubject').value = '';
            document.getElementById('bulkRoom').value = '';
            selectBulkColor(0);
            
            // 状態リセット
            bulkSelectedPeriods = new Set([1]); // デフォルト1限
            bulkSelectedDays = new Set([1]);    // デフォルト月曜
            updateBulkPeriodUI();
            updateBulkDayUI();

            toggleSpecificDay(); 

            // 期間のデフォルト設定（現在表示中の月の初日〜末日）
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1;
            const lastDay = new Date(year, month, 0).getDate();
            
            const toDateStr = (y, m, d) => `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            document.getElementById('bulkStartDate').value = toDateStr(year, month, 1);
            document.getElementById('bulkEndDate').value = toDateStr(year, month, lastDay);

            openModalAnimation('bulkModal', 'bulkModalContent');
        }

        function toggleSpecificDay() {
            const rule = document.getElementById('bulkRule').value;
            const selector = document.getElementById('specificDaySelector');
            if (rule === 'specificDay') {
                selector.classList.remove('hidden');
            } else {
                selector.classList.add('hidden');
            }
        }

        function toggleBulkPeriod(period) {
            if (bulkSelectedPeriods.has(period)) {
                if (bulkSelectedPeriods.size > 1) { // 少なくとも1つは選択させる
                    bulkSelectedPeriods.delete(period);
                }
            } else {
                bulkSelectedPeriods.add(period);
            }
            updateBulkPeriodUI();
        }

        function updateBulkPeriodUI() {
            periods.forEach(p => {
                const btn = document.getElementById(`bulk-period-btn-${p}`);
                if (bulkSelectedPeriods.has(p)) {
                    btn.className = 'px-2 py-2 rounded-lg text-xs font-bold transition-all bg-slate-800 text-white shadow-md flex items-center justify-center';
                } else {
                    btn.className = 'px-2 py-2 rounded-lg text-xs font-bold transition-all border border-slate-200 hover:bg-slate-50 bg-white text-slate-600 flex items-center justify-center';
                }
            });
        }

        function toggleBulkDay(index) {
            if (bulkSelectedDays.has(index)) {
                if (bulkSelectedDays.size > 1) { // 少なくとも1つは選択させる
                    bulkSelectedDays.delete(index);
                }
            } else {
                bulkSelectedDays.add(index);
            }
            updateBulkDayUI();
        }

        function updateBulkDayUI() {
            const days = [0,1,2,3,4,5,6];
            days.forEach(i => {
                const btn = document.getElementById(`bulk-day-${i}`);
                if (bulkSelectedDays.has(i)) {
                    btn.className = 'w-9 h-9 rounded-full text-xs font-bold transition-all bg-slate-800 text-white shadow-lg shadow-slate-300 scale-110 flex items-center justify-center';
                } else {
                    btn.className = 'w-9 h-9 rounded-full text-xs font-bold transition-all border border-slate-200 hover:bg-slate-100 bg-white text-slate-500 flex items-center justify-center';
                }
            });
        }

        function applyBulkRule() {
            const subject = document.getElementById('bulkSubject').value;
            if (!subject) {
                alert('科目名を入力してください');
                return;
            }
            const room = document.getElementById('bulkRoom').value;
            
            const rule = document.getElementById('bulkRule').value;
            const targetPeriods = Array.from(bulkSelectedPeriods);

            // 期間の取得
            const startDateVal = document.getElementById('bulkStartDate').value;
            const endDateVal = document.getElementById('bulkEndDate').value;
            if (!startDateVal || !endDateVal) {
                alert('期間を設定してください');
                return;
            }

            const startDate = new Date(startDateVal);
            const endDate = new Date(endDateVal);
            if (startDate > endDate) {
                alert('開始日は終了日より前の日付にしてください');
                return;
            }

            let count = 0;
            // 開始日から終了日までループ
            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                let shouldUpdate = false;
                const dayNum = d.getDate();
                const dayIndex = d.getDay();

                switch (rule) {
                    case 'everyday': shouldUpdate = true; break;
                    case 'even': if (dayNum % 2 === 0) shouldUpdate = true; break;
                    case 'odd': if (dayNum % 2 !== 0) shouldUpdate = true; break;
                    case 'multiple3': if (dayNum % 3 === 0) shouldUpdate = true; break;
                    case 'specificDay': if (bulkSelectedDays.has(dayIndex)) shouldUpdate = true; break;
                }

                if (shouldUpdate) {
                    // 選択された全ての時限に対して登録
                    targetPeriods.forEach(p => {
                        const y = d.getFullYear();
                        const m = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        const key = `${y}-${m}-${day}-${p}`;
                        
                        schedule[key] = { subject, room, color: bulkColorIndex };
                        count++;
                    });
                }
            }

            saveData();
            closeModal('bulkModal');
            if(currentView === 'today') renderTodayView();
            else renderGrid();
            alert(`${count}件のデータを一括登録しました`);
        }
    </script>
</body>
</html>
