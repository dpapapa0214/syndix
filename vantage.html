<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- 画像読み込みのセキュリティ制約を緩和 -->
    <meta name="referrer" content="no-referrer">
    <title>Vantage - News Reader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Inter:wght@400;600&display=swap');
        
        :root {
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.5);
            --sidebar-bg: #f8fafc;
            --accent-color: #2563eb;
        }

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
            -webkit-font-smoothing: antialiased;
        }

        /* カスタムスクロールバー */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* ユーティリティ */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -10px rgba(0, 0, 0, 0.15);
        }

        /* ローディングアニメーション */
        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid #e2e8f0;
            border-bottom-color: var(--accent-color);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }

        /* 画像オーバーレイグラデーション */
        .img-gradient {
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 60%);
        }

        /* タップハイライト無効化 (モバイル) */
        * {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- サイドバー -->
    <aside class="w-full md:w-72 bg-slate-50 border-r border-slate-200 flex flex-col z-20 shadow-lg md:shadow-none h-auto md:h-full shrink-0 transition-all duration-300">
        <div class="p-6 border-b border-slate-200 flex justify-between items-center bg-white md:bg-transparent">
            <h1 class="font-black text-2xl tracking-tight text-slate-800 flex items-center gap-2">
                <span class="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm shadow-md md:shadow-blue-200"><i class="fas fa-mountain"></i></span>
                Vantage.
            </h1>
            <!-- モバイル用メニューボタン -->
            <button class="md:hidden text-slate-500 hover:text-blue-600" onclick="toggleMobileMenu()">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </div>
        
        <!-- ナビゲーション -->
        <div class="flex-1 overflow-y-auto overflow-x-hidden p-4 space-y-6 hidden md:block" id="sidebar-content">
            <!-- ホーム -->
            <div class="mb-4">
                <button 
                    onclick="selectHome()"
                    id="btn-home"
                    class="source-btn w-full text-left px-3 py-2.5 rounded-xl hover:bg-white hover:shadow-sm hover:text-blue-600 transition-all text-slate-600 flex items-center gap-3 group relative overflow-hidden mb-1"
                >
                    <div class="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center shadow-sm shrink-0 z-10">
                        <i class="fas fa-home text-xs"></i>
                    </div>
                    <span class="font-bold text-sm z-10">ホーム (全ニュース)</span>
                    <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-0"></div>
                </button>
            </div>

            <!-- フィード一覧 -->
            <div>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 px-3">Feeds</h3>
                <div class="space-y-1" id="source-list">
                    <!-- JSで生成 -->
                </div>
            </div>

            <!-- ライブラリ -->
            <div>
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 px-3">Library</h3>
                <div class="space-y-1">
                    <button onclick="showBookmarks()" id="btn-bookmarks" class="w-full text-left px-3 py-2.5 rounded-xl hover:bg-white hover:shadow-sm hover:text-blue-600 transition-all text-slate-600 flex items-center gap-3 group">
                        <span class="w-8 h-8 rounded-full bg-pink-100 text-pink-500 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i class="fas fa-heart text-xs"></i>
                        </span>
                        <span class="font-medium text-sm">保存した記事</span>
                        <span id="bookmark-count" class="ml-auto bg-slate-200 text-slate-600 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- モバイル用ドロワーメニュー (デフォルト非表示) -->
        <div id="mobile-menu" class="hidden md:hidden absolute top-[73px] left-0 w-full h-[calc(100vh-73px)] bg-slate-50 z-30 overflow-y-auto p-4 border-b border-slate-200">
            <!-- モバイルメニューの中身はJSで制御 -->
        </div>
    </aside>

    <!-- メインエリア -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-[#f8fafc]">
        <!-- ヘッダー -->
        <header class="glass sticky top-0 z-10 px-6 py-4 flex flex-col md:flex-row gap-4 md:gap-0 justify-between items-center shadow-sm">
            <div class="w-full md:w-auto">
                <h2 id="page-title" class="font-bold text-xl text-slate-800 truncate">Top Stories</h2>
                <div class="flex items-center gap-2 text-xs text-slate-500 mt-0.5">
                    <span id="status-dot" class="w-2 h-2 rounded-full bg-slate-300"></span>
                    <span id="status-text">待機中</span>
                </div>
            </div>

            <!-- 検索バー -->
            <div class="relative w-full md:w-64 lg:w-80 group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
                </div>
                <input 
                    type="text" 
                    id="search-input"
                    oninput="handleSearch(this.value)"
                    placeholder="記事を検索..." 
                    class="block w-full pl-10 pr-3 py-2 border border-slate-200 rounded-full leading-5 bg-slate-50 text-slate-900 placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all sm:text-sm shadow-sm"
                >
            </div>

            <div class="hidden md:flex gap-2 ml-4">
                <button onclick="refreshFeed()" class="w-10 h-10 rounded-full bg-white border border-slate-200 text-slate-500 hover:text-blue-600 hover:border-blue-200 shadow-sm flex items-center justify-center transition-all active:scale-95" title="更新">
                    <i class="fas fa-rotate" id="refresh-icon"></i>
                </button>
            </div>
        </header>

        <!-- コンテンツコンテナ -->
        <div id="scroll-container" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth">
            
            <!-- ヒーローセクション (トップニュース) -->
            <div id="hero-section" class="mb-8 hidden fade-in-up">
                <!-- JSで挿入 -->
            </div>

            <!-- ローディング -->
            <div id="loading" class="flex flex-col items-center justify-center h-64 fade-in-up">
                <span class="loader mb-6"></span>
                <p class="text-slate-400 font-medium animate-pulse">読み込んでいます...</p>
            </div>

            <!-- エラー -->
            <div id="error-message" class="hidden flex flex-col items-center justify-center h-64 text-center fade-in-up">
                <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mb-4 text-red-400">
                    <i class="fas fa-wifi text-2xl"></i>
                </div>
                <h3 class="text-slate-800 font-bold text-lg mb-2">接続できませんでした</h3>
                <p class="text-slate-500 mb-6 text-sm max-w-xs mx-auto">ネットワーク接続を確認するか、しばらく経ってから再読み込みしてください。</p>
                <button onclick="refreshFeed()" class="bg-slate-800 text-white px-6 py-2.5 rounded-full text-sm font-bold hover:bg-slate-700 transition-colors shadow-lg shadow-slate-200">
                    もう一度試す
                </button>
            </div>

            <!-- 検索結果ゼロ表示 -->
            <div id="no-search-results" class="hidden flex flex-col items-center justify-center h-64 text-center fade-in-up">
                <div class="text-slate-300 mb-3 text-4xl">
                    <i class="fas fa-search"></i>
                </div>
                <p class="text-slate-500 font-medium">該当する記事が見つかりませんでした</p>
                <button onclick="document.getElementById('search-input').value=''; handleSearch('')" class="text-blue-500 text-sm mt-2 hover:underline">検索ワードをクリア</button>
            </div>

            <!-- グリッドレイアウト -->
            <div id="articles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
                <!-- JSでカード挿入 -->
            </div>
            
            <!-- ブックマーク空表示 -->
            <div id="empty-bookmarks" class="hidden flex flex-col items-center justify-center h-[50vh] text-center fade-in-up">
                <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-6 text-slate-300">
                    <i class="far fa-heart text-3xl"></i>
                </div>
                <h3 class="text-slate-700 font-bold text-lg mb-2">まだ記事がありません</h3>
                <p class="text-slate-400 text-sm">ニュース記事の ♡ ボタンを押して<br>ここに追加しましょう。</p>
            </div>
        </div>
    </main>

    <script>
        /**
         * 設定とデータ
         */
        const feeds = [
            { id: 'nikkei', name: '日本経済新聞', url: 'https://assets.wor.jp/rss/rdf/nikkei/news.rdf', color: 'bg-emerald-500', icon: 'fa-chart-line' },
            { id: 'reuters', name: 'ロイター', url: 'https://assets.wor.jp/rss/rdf/reuters/top.rdf', color: 'bg-orange-500', icon: 'fa-globe' },
            { id: 'nhk', name: 'NHKニュース', url: 'https://www.nhk.or.jp/rss/news/cat0.xml', color: 'bg-blue-600', icon: 'fa-tv' },
            { id: 'asahi', name: '朝日新聞', url: 'https://www.asahi.com/rss/asahi/newsheadlines.rdf', color: 'bg-rose-500', icon: 'fa-newspaper' },
            { id: 'animeanime', name: 'アニメ！アニメ！', url: 'https://animeanime.jp/rss/index.rdf', color: 'bg-purple-500', icon: 'fa-video' }
        ];

        const CACHE_DURATION_MS = 30 * 60 * 1000;

        // Unsplash画像マッピング（ジャンル細分化・大量追加）
        const unsplashImages = {
            // 経済・ビジネス
            'economy': 'https://images.unsplash.com/photo-1611974765270-ca12586343bb?auto=format&fit=crop&q=80&w=800',
            'stock': 'https://images.unsplash.com/photo-1611974765270-ca12586343bb?auto=format&fit=crop&q=80&w=800',
            'money': 'https://images.unsplash.com/photo-1580519542036-c47de6196ba5?auto=format&fit=crop&q=80&w=800',
            'crypto': 'https://images.unsplash.com/photo-1518546305927-5a555bb7020d?auto=format&fit=crop&q=80&w=800',
            'startup': 'https://images.unsplash.com/photo-1556761175-5973dc0f32e7?auto=format&fit=crop&q=80&w=800',
            'office': 'https://images.unsplash.com/photo-1497366216548-37526070297c?auto=format&fit=crop&q=80&w=800',

            // 政治・国際
            'politics': 'https://images.unsplash.com/photo-1529108339678-b118742b827e?auto=format&fit=crop&q=80&w=800',
            'diplomacy': 'https://images.unsplash.com/photo-1520696985121-78950d9703d8?auto=format&fit=crop&q=80&w=800',
            'conflict': 'https://images.unsplash.com/photo-1557025805-4c667469a8b5?auto=format&fit=crop&q=80&w=800',
            'usa': 'https://images.unsplash.com/photo-1508433957232-3107f5fd5995?auto=format&fit=crop&q=80&w=800',
            'china': 'https://images.unsplash.com/photo-1547981609-4b6bfe67ca0b?auto=format&fit=crop&q=80&w=800',

            // テクノロジー
            'tech': 'https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&q=80&w=800',
            'ai': 'https://images.unsplash.com/photo-1620712943543-bcc4688e7485?auto=format&fit=crop&q=80&w=800',
            'mobile': 'https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?auto=format&fit=crop&q=80&w=800',
            'robot': 'https://images.unsplash.com/photo-1485827404703-89b55fcc595e?auto=format&fit=crop&q=80&w=800',
            'cyber': 'https://images.unsplash.com/photo-1550751827-4bd374c3f58b?auto=format&fit=crop&q=80&w=800',
            'gaming': 'https://images.unsplash.com/photo-1542751371-adc38448a05e?auto=format&fit=crop&q=80&w=800',
            'gadget': 'https://images.unsplash.com/photo-1519389950473-47ba0277781c?auto=format&fit=crop&q=80&w=800',

            // スポーツ
            'sports': 'https://images.unsplash.com/photo-1461896836934-ffe607ba8211?auto=format&fit=crop&q=80&w=800',
            'baseball': 'https://images.unsplash.com/photo-1588675122709-64da943f9c63?auto=format&fit=crop&q=80&w=800',
            'soccer': 'https://images.unsplash.com/photo-1579952363873-27f3bade9f55?auto=format&fit=crop&q=80&w=800',
            'basketball': 'https://images.unsplash.com/photo-1546519638-68e109498ffc?auto=format&fit=crop&q=80&w=800',
            'tennis': 'https://images.unsplash.com/photo-1595435934249-5df7ed86e1c0?auto=format&fit=crop&q=80&w=800',

            // 産業・科学
            'car': 'https://images.unsplash.com/photo-1492144534655-ae79c964c9d7?auto=format&fit=crop&q=80&w=800',
            'space': 'https://images.unsplash.com/photo-1446776811953-b23d57bd21aa?auto=format&fit=crop&q=80&w=800',
            'medical': 'https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?auto=format&fit=crop&q=80&w=800',
            'environment': 'https://images.unsplash.com/photo-1470071459604-3b5ec3a7fe05?auto=format&fit=crop&q=80&w=800',

            // 社会・生活
            'disaster': 'https://images.unsplash.com/photo-1583344186595-5db0b53c7a33?auto=format&fit=crop&q=80&w=800',
            'weather': 'https://images.unsplash.com/photo-1592210454359-9043f067919b?auto=format&fit=crop&q=80&w=800',
            'food': 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?auto=format&fit=crop&q=80&w=800',
            'cafe': 'https://images.unsplash.com/photo-1509042239860-f550ce710b93?auto=format&fit=crop&q=80&w=800',
            'health': 'https://images.unsplash.com/photo-1505751172876-fa1923c5c528?auto=format&fit=crop&q=80&w=800',
            'education': 'https://images.unsplash.com/photo-1503676260728-1c00da094a0b?auto=format&fit=crop&q=80&w=800',
            'police': 'https://images.unsplash.com/photo-1453873419066-95775f24879d?auto=format&fit=crop&q=80&w=800',
            'travel': 'https://images.unsplash.com/photo-1488646953014-85cb44e25828?auto=format&fit=crop&q=80&w=800',
            'fashion': 'https://images.unsplash.com/photo-1483985988355-763728e1935b?auto=format&fit=crop&q=80&w=800',

            // エンタメ・カルチャー
            'anime': 'https://images.unsplash.com/photo-1613376023733-0a73315d9b06?auto=format&fit=crop&q=80&w=800', // アニメ・コミック風
            'movie': 'https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?auto=format&fit=crop&q=80&w=800',
            'music': 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?auto=format&fit=crop&q=80&w=800',
            'entertainment': 'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?auto=format&fit=crop&q=80&w=800',
            'book': 'https://images.unsplash.com/photo-1495446815901-a7297e633e8d?auto=format&fit=crop&q=80&w=800',
            'art': 'https://images.unsplash.com/photo-1513364776144-60967b0f800f?auto=format&fit=crop&q=80&w=800',

            // その他
            'interview': 'https://images.unsplash.com/photo-1554200876-56c2f25224fa?auto=format&fit=crop&q=80&w=800',
            'default': 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?auto=format&fit=crop&q=80&w=800'
        };

        const keywordMap = {
            // 経済・ビジネス
            '株': 'stock', '市場': 'market', '日経平均': 'stock', 'ダウ': 'stock', 'ナスダック': 'stock', '上場': 'stock',
            '円': 'money', '為替': 'money', 'ドル': 'money', 'ユーロ': 'money', '銀行': 'money', '金利': 'money',
            'ビットコイン': 'crypto', '仮想通貨': 'crypto', 'ブロックチェーン': 'crypto',
            '経済': 'economy', '金融': 'economy', 'インフレ': 'economy', '景気': 'economy', 'GDP': 'economy',
            '決算': 'economy', '業績': 'economy', '利益': 'economy', '赤字': 'economy', '黒字': 'economy',
            'NISA': 'money', '投資': 'money', '資産': 'money', '税': 'money',
            'スタートアップ': 'startup', '起業': 'startup', 'ベンチャー': 'startup', '資金調達': 'startup',
            '社長': 'office', '人事': 'office', '採用': 'office', '働き方': 'office', '賃上げ': 'office',

            // 政治・国際
            '首相': 'politics', '総理': 'politics', '内閣': 'politics', '政府': 'politics', '知事': 'politics',
            '国会': 'politics', '自民': 'politics', '野党': 'politics', '選挙': 'politics', '政策': 'politics', '法案': 'politics',
            '大統領': 'diplomacy', '米国': 'usa', 'アメリカ': 'usa', 'トランプ': 'usa', 'バイデン': 'usa',
            '中国': 'china', '習近平': 'china', '北京': 'china',
            'ウクライナ': 'conflict', 'ロシア': 'conflict', '戦争': 'conflict', '軍': 'conflict',
            '外交': 'diplomacy', '首脳': 'diplomacy', '北朝鮮': 'diplomacy', 'ミサイル': 'diplomacy', '海外': 'diplomacy',

            // テクノロジー
            'AI': 'ai', '人工知能': 'ai', 'ChatGPT': 'ai', '生成': 'ai', 'LLM': 'ai',
            'IT': 'tech', 'デジタル': 'tech', 'ネット': 'tech', 'ソフト': 'tech', 'システム': 'tech',
            'サイバー': 'cyber', 'セキュリティ': 'cyber', 'ハッカー': 'cyber',
            '半導体': 'tech', 'チップ': 'tech',
            'スマホ': 'mobile', 'iPhone': 'mobile', 'Android': 'mobile', 'アプリ': 'mobile', '携帯': 'mobile',
            'ロボット': 'robot', 'ドローン': 'robot', '開発': 'tech',
            'ゲーム': 'gaming', '任天堂': 'gaming', 'ソニー': 'gaming', 'プレステ': 'gaming', 'Switch': 'gaming', 'eスポーツ': 'gaming',
            'PC': 'gadget', 'Mac': 'gadget', 'カメラ': 'gadget', 'デバイス': 'gadget',
            'Google': 'tech', 'Apple': 'tech', 'Microsoft': 'tech', 'Amazon': 'tech',

            // スポーツ
            '野球': 'baseball', '大谷': 'baseball', 'プロ野球': 'baseball', 'MLB': 'baseball', '球団': 'baseball', 'ドラフト': 'baseball', '甲子園': 'baseball',
            'サッカー': 'soccer', 'Jリーグ': 'soccer', '代表': 'soccer', 'W杯': 'soccer', '欧州CL': 'soccer',
            'バスケ': 'basketball', 'NBA': 'basketball', 'Bリーグ': 'basketball',
            'テニス': 'tennis', '卓球': 'tennis',
            '五輪': 'sports', 'オリンピック': 'sports', 'スポーツ': 'sports', 
            'ゴルフ': 'sports', '相撲': 'sports', '優勝': 'sports', 'メダル': 'sports', '陸上': 'sports', 'マラソン': 'sports',

            // 産業・科学
            '車': 'car', '自動車': 'car', 'トヨタ': 'car', 'EV': 'car', 'ホンダ': 'car', '日産': 'car',
            '宇宙': 'space', 'ロケット': 'space', '月面': 'space', '衛星': 'space', 'NASA': 'space', 'JAXA': 'space',
            '医療': 'medical', 'がん': 'medical', '治療': 'medical', '薬': 'medical', '病院': 'medical',
            '環境': 'environment', '脱炭素': 'environment', 'エネルギー': 'environment', '原発': 'environment', '温暖化': 'environment',

            // 社会・生活
            '地震': 'disaster', '震度': 'disaster', '津波': 'disaster', '防災': 'disaster', '避難': 'disaster',
            '台風': 'weather', '大雨': 'weather', '天気': 'weather', '気象': 'weather', '猛暑': 'weather', '雪': 'weather',
            '事件': 'police', '事故': 'police', '警察': 'police', '逮捕': 'police', '裁判': 'police', '容疑者': 'police',
            'グルメ': 'food', '食品': 'food', '料理': 'food', '野菜': 'food', 'マクドナルド': 'food', '飲食': 'food', 'ラーメン': 'food', '酒': 'food',
            'カフェ': 'cafe', 'スタバ': 'cafe', 'スイーツ': 'cafe',
            '健康': 'health', 'コロナ': 'health', 'ワクチン': 'health', '睡眠': 'health', 'ダイエット': 'health',
            '教育': 'education', '大学': 'education', '受験': 'education', '学校': 'education', '子育て': 'education',
            '旅行': 'travel', '観光': 'travel', 'ホテル': 'travel', '空港': 'travel', '新幹線': 'travel', 'インバウンド': 'travel',
            'ファッション': 'fashion', '服': 'fashion', 'ユニクロ': 'fashion', 'ブランド': 'fashion',

            // エンタメ・アニメ
            '映画': 'movie', 'シネマ': 'movie', '劇場版': 'movie', 'ドラマ': 'movie',
            'アニメ': 'anime', 'マンガ': 'anime', '漫画': 'anime', '声優': 'anime', 'キャラ': 'anime', 
            '放送': 'anime', '配信': 'anime', 'PV': 'anime', '連載': 'anime', '新作': 'anime', '決定': 'anime',
            'ガンダム': 'anime', 'ポケモン': 'anime', 'ジャンプ': 'anime', 'プリキュア': 'anime', 'コナン': 'anime',
            '音楽': 'music', 'ライブ': 'music', 'バンド': 'music', '歌手': 'music', '曲': 'music',
            '芸能': 'entertainment', 'アイドル': 'entertainment', 'タレント': 'entertainment', '俳優': 'entertainment', '女優': 'entertainment',
            '将棋': 'book', '本': 'book', '小説': 'book', '芥川賞': 'book', '直木賞': 'book',
            '展': 'art', '美術': 'art', 'アート': 'art',
            
            // その他
            'インタビュー': 'interview', '対談': 'interview'
        };

        let currentFeedId = null;
        let isShowingBookmarks = false;
        let bookmarks = JSON.parse(localStorage.getItem('news_bookmarks') || '[]');
        let currentItems = []; // 現在表示中の記事リスト（検索用）

        /**
         * 初期化とUI構築
         */
        function init() {
            renderSidebar();
            updateBookmarkCount();
            
            // 初回ロードはホーム画面
            selectHome();

            // モバイルメニューのセットアップ
            setupMobileMenu();
        }

        function setupMobileMenu() {
            const sidebarContent = document.getElementById('sidebar-content').innerHTML;
            document.getElementById('mobile-menu').innerHTML = sidebarContent;
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }

        function renderSidebar() {
            const container = document.getElementById('source-list');
            container.innerHTML = feeds.map(feed => `
                <button 
                    onclick="selectSource('${feed.id}')"
                    id="btn-${feed.id}"
                    class="source-btn w-full text-left px-3 py-2.5 rounded-xl hover:bg-white hover:shadow-sm hover:text-blue-600 transition-all text-slate-600 flex items-center gap-3 group relative overflow-hidden"
                >
                    <div class="w-8 h-8 rounded-full ${feed.color} text-white flex items-center justify-center shadow-sm shrink-0 z-10">
                        <i class="fas ${feed.icon} text-xs"></i>
                    </div>
                    <span class="font-medium text-sm z-10">${feed.name}</span>
                    <div class="absolute inset-0 bg-white opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-0"></div>
                </button>
            `).join('');
        }

        /**
         * 検索機能
         */
        function handleSearch(query) {
            query = query.toLowerCase().trim();
            
            // 検索ボックスが空の場合は全件表示
            if (!query) {
                renderContent(currentItems, false, true); // true = 検索モードではない（通常表示）
                return;
            }

            // タイトルまたは説明文でフィルタリング
            const filtered = currentItems.filter(item => 
                (item.title && item.title.toLowerCase().includes(query)) || 
                (item.description && item.description.toLowerCase().includes(query))
            );

            // ヒーローセクションを隠し、結果を表示
            document.getElementById('hero-section').classList.add('hidden');
            
            if (filtered.length === 0) {
                document.getElementById('articles-grid').innerHTML = '';
                document.getElementById('no-search-results').classList.remove('hidden');
            } else {
                document.getElementById('no-search-results').classList.add('hidden');
                renderGrid(filtered, false);
            }
        }

        /**
         * 状態管理・アクション
         */

        // ホーム（全件）選択
        async function selectHome(forceRefresh = false) {
            currentFeedId = 'home';
            isShowingBookmarks = false;
            document.getElementById('search-input').value = ''; // 検索クリア
            document.getElementById('no-search-results').classList.add('hidden');

            updateActiveState('home');
            document.getElementById('mobile-menu').classList.add('hidden');
            document.getElementById('page-title').textContent = 'ホーム (全ニュース)';
            document.getElementById('error-message').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('articles-grid').innerHTML = '';
            document.getElementById('hero-section').classList.add('hidden');
            document.getElementById('empty-bookmarks').classList.add('hidden');

            updateStatus('loading');

            try {
                // すべてのフィードからデータを取得（並列処理）
                const promises = feeds.map(feed => getFeedItems(feed, forceRefresh));
                const results = await Promise.all(promises);
                
                // 全記事を結合してフラットにする
                const allItems = results.flat();

                // 日付順（新しい順）にソート
                allItems.sort((a, b) => {
                    const timeA = a.timestamp || 0;
                    const timeB = b.timestamp || 0;
                    return timeB - timeA;
                });

                currentItems = allItems;
                renderContent(allItems, false);
                updateStatus('live');

            } catch (e) {
                console.error("Home fetch error", e);
                updateStatus('error');
                if (document.getElementById('articles-grid').children.length === 0) {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('error-message').classList.remove('hidden');
                }
            }
        }

        // 個別ソース選択
        async function selectSource(id, forceRefresh = false) {
            currentFeedId = id;
            isShowingBookmarks = false;
            document.getElementById('search-input').value = ''; // 検索クリア
            document.getElementById('no-search-results').classList.add('hidden');
            
            updateActiveState(id);
            document.getElementById('mobile-menu').classList.add('hidden');
            document.getElementById('hero-section').classList.add('hidden');
            document.getElementById('empty-bookmarks').classList.add('hidden');
            document.getElementById('page-title').textContent = feeds.find(f => f.id === id).name;
            document.getElementById('error-message').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('articles-grid').innerHTML = '';

            updateStatus('loading');

            try {
                const feed = feeds.find(f => f.id === id);
                const items = await getFeedItems(feed, forceRefresh);
                
                currentItems = items;
                renderContent(items, false);
                
                // キャッシュかどうか判定してステータス更新
                const cached = loadCache(id);
                if (cached && !forceRefresh && (Date.now() - cached.timestamp < CACHE_DURATION_MS)) {
                    const age = Date.now() - cached.timestamp;
                    const mins = Math.floor(age / 60000);
                    const timeStr = mins < 1 ? 'たった今' : `${mins}分前`;
                    updateStatus('cached_valid', timeStr);
                } else {
                    updateStatus('live');
                }

            } catch (e) {
                console.error(e);
                updateStatus('error');
                if (document.getElementById('articles-grid').children.length === 0) {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('error-message').classList.remove('hidden');
                }
            }
        }

        // データの取得ロジック（キャッシュ利用判定込み）
        async function getFeedItems(feed, forceRefresh) {
            // キャッシュチェック
            const cached = loadCache(feed.id);
            if (cached && !forceRefresh) {
                const age = Date.now() - cached.timestamp;
                if (age < CACHE_DURATION_MS) {
                    return cached.items;
                }
            }

            // 新規取得
            const fetchedItems = await fetchFeedData(feed.url);
            saveCache(feed.id, fetchedItems);
            return fetchedItems;
        }

        function showBookmarks() {
            isShowingBookmarks = true;
            currentFeedId = null;
            document.getElementById('search-input').value = '';
            document.getElementById('no-search-results').classList.add('hidden');
            
            // UI更新
            document.querySelectorAll('.source-btn').forEach(btn => btn.classList.remove('bg-white', 'shadow-sm', 'text-blue-600'));
            document.getElementById('btn-home').classList.remove('bg-white', 'shadow-sm', 'text-blue-600');
            const btn = document.getElementById('btn-bookmarks');
            btn.classList.add('bg-white', 'shadow-sm', 'text-pink-600');
            
            document.getElementById('page-title').textContent = '保存した記事';
            document.getElementById('hero-section').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error-message').classList.add('hidden');
            document.getElementById('mobile-menu').classList.add('hidden');

            const grid = document.getElementById('articles-grid');
            grid.innerHTML = '';

            if (bookmarks.length === 0) {
                document.getElementById('empty-bookmarks').classList.remove('hidden');
                currentItems = [];
            } else {
                document.getElementById('empty-bookmarks').classList.add('hidden');
                // ブックマーク一覧はすべて通常カードとして表示（新しい順）
                const items = bookmarks.slice().reverse();
                currentItems = items;
                renderGrid(items, false); 
            }
            updateStatus('bookmarks');
        }

        function updateActiveState(id) {
            // サイドバーボタンのアクティブ化
            document.querySelectorAll('.source-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'shadow-sm', 'text-blue-600', 'ring-1', 'ring-slate-100');
            });
            document.getElementById('btn-bookmarks').classList.remove('bg-white', 'shadow-sm', 'text-pink-600');
            
            if (id === 'home') {
                const active = document.getElementById('btn-home');
                if (active) active.classList.add('bg-white', 'shadow-sm', 'text-blue-600', 'ring-1', 'ring-slate-100');
            } else {
                const active = document.getElementById(`btn-${id}`);
                if (active) active.classList.add('bg-white', 'shadow-sm', 'text-blue-600', 'ring-1', 'ring-slate-100');
            }
        }

        function updateStatus(type, payload = null) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            const refreshIcon = document.getElementById('refresh-icon');

            if (type === 'loading') {
                dot.className = 'w-2 h-2 rounded-full bg-blue-500 animate-pulse';
                text.textContent = '更新中...';
                refreshIcon.classList.add('fa-spin');
            } else if (type === 'cached') {
                dot.className = 'w-2 h-2 rounded-full bg-orange-400';
                text.textContent = '最新を取得中';
                refreshIcon.classList.add('fa-spin');
            } else if (type === 'cached_valid') {
                dot.className = 'w-2 h-2 rounded-full bg-blue-400';
                text.textContent = `更新済み (${payload})`;
                refreshIcon.classList.remove('fa-spin');
            } else if (type === 'live') {
                dot.className = 'w-2 h-2 rounded-full bg-emerald-500';
                const date = new Date();
                text.textContent = `更新完了 ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                refreshIcon.classList.remove('fa-spin');
            } else if (type === 'bookmarks') {
                dot.className = 'w-2 h-2 rounded-full bg-pink-500';
                text.textContent = '保存済み';
                refreshIcon.classList.remove('fa-spin');
            } else if (type === 'error') {
                dot.className = 'w-2 h-2 rounded-full bg-red-500';
                text.textContent = 'エラー';
                refreshIcon.classList.remove('fa-spin');
            }
        }

        /**
         * ニュース取得ロジック（単体）
         */
        async function fetchFeedData(rssUrl) {
            // プロキシ戦略
            const strategies = [
                // 1. AllOrigins (JSON)
                async () => {
                    const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(rssUrl)}&t=${Date.now()}`);
                    if (!res.ok) throw new Error('AllOrigins failed');
                    const json = await res.json();
                    if (!json.contents) throw new Error('No content');
                    return { type: 'xml', data: json.contents };
                },
                // 2. CorsProxy.io (XML)
                async () => {
                    const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(rssUrl)}?t=${Date.now()}`);
                    if (!res.ok) throw new Error('CorsProxy failed');
                    return { type: 'xml', data: await res.text() };
                },
                // 3. rss2json (JSON API)
                async () => {
                    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`);
                    if (!res.ok) throw new Error('rss2json failed');
                    const json = await res.json();
                    if (json.status !== 'ok') throw new Error('rss2json status error');
                    return { type: 'json', data: json.items };
                }
            ];

            let result = null;
            for (const strategy of strategies) {
                try { result = await strategy(); break; } catch (e) { console.warn(e); }
            }
            if (!result) throw new Error('All proxies failed');

            let items = [];
            if (result.type === 'json') {
                items = parseJSONItems(result.data);
            } else {
                const parser = new DOMParser();
                const doc = parser.parseFromString(result.data, "text/xml");
                items = parseRSS(doc);
            }
            return items;
        }

        function parseRSS(doc) {
            return Array.from(doc.querySelectorAll('item, entry')).map(node => {
                const title = getTag(node, 'title');
                const link = getTag(node, 'link', 'href') || getTag(node, 'link');
                let desc = getTag(node, 'description') || getTag(node, 'content') || getTag(node, 'summary') || '';
                
                // content:encoded も確認
                const contentEncoded = getTag(node, 'encoded', null, 'content') || getTag(node, 'content:encoded');
                if (contentEncoded) desc = contentEncoded;

                const dateStr = getTag(node, 'dc:date') || getTag(node, 'pubDate') || getTag(node, 'updated');
                
                // 画像抽出 (優先度順)
                let img = null;
                
                // 1. media:thumbnail
                const media = node.getElementsByTagName('media:thumbnail')[0];
                if (media) img = media.getAttribute('url');
                
                // 2. enclosure
                if (!img) {
                    const enc = node.getElementsByTagName('enclosure')[0];
                    if (enc && enc.getAttribute('type')?.startsWith('image')) img = enc.getAttribute('url');
                }
                
                // 3. media:content
                if (!img) {
                    const mediaContent = node.getElementsByTagName('media:content')[0];
                    if (mediaContent && mediaContent.getAttribute('type')?.startsWith('image')) img = mediaContent.getAttribute('url');
                    else if (mediaContent && mediaContent.getAttribute('medium') === 'image') img = mediaContent.getAttribute('url');
                }

                // 4. 本文中の画像 (src="...")
                if (!img && desc) {
                    const match = desc.match(/src=["']([^"']+)["']/);
                    if (match) img = match[1];
                }

                // 本文整形
                const div = document.createElement('div');
                div.innerHTML = desc;
                const cleanDesc = (div.textContent || '').substring(0, 100) + '...';

                // 日付
                let date = '日付不明';
                let timestamp = 0;
                try { 
                    const d = new Date(dateStr);
                    timestamp = d.getTime();
                    date = d.toLocaleDateString('ja-JP', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}); 
                } catch(e){}

                // 画像生成 (フォールバック)
                if (!img) img = getImageByTitle(title);

                return { title, link, description: cleanDesc, date, timestamp, imageUrl: img, id: link };
            }).filter(i => i.title && i.link);
        }

        function parseJSONItems(items) {
            return items.map(item => {
                let img = item.thumbnail || item.enclosure?.link;
                
                // 本文から検索
                if (!img && item.content) {
                    const match = item.content.match(/src=["']([^"']+)["']/);
                    if (match) img = match[1];
                }

                if (!img) img = getImageByTitle(item.title);
                
                const div = document.createElement('div');
                div.innerHTML = item.description || '';
                const desc = (div.textContent || '').substring(0, 100) + '...';

                let date = '日付不明';
                let timestamp = 0;
                try { 
                    const d = new Date(item.pubDate);
                    timestamp = d.getTime();
                    date = d.toLocaleDateString('ja-JP', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}); 
                } catch(e){}

                return { title: item.title, link: item.link, description: desc, date, timestamp, imageUrl: img, id: item.link };
            });
        }

        function getTag(parent, tag, attr, ns) {
            let el = parent.getElementsByTagName(tag)[0];
            if (!el) el = parent.getElementsByTagName('dc:' + tag)[0];
            if (!el && ns) el = parent.getElementsByTagName(ns + ':' + tag)[0];
            
            return el ? (attr ? el.getAttribute(attr) : el.textContent) : null;
        }

        // キーワードに基づいてUnsplash画像を返す
        function getImageByTitle(title) {
            for (const [key, category] of Object.entries(keywordMap)) {
                if (title.includes(key)) return unsplashImages[category];
            }
            return unsplashImages['default'];
        }

        /**
         * レンダリング
         */
        function renderContent(items, isCache, skipHero = false) {
            document.getElementById('loading').classList.add('hidden');
            
            if (items.length === 0) {
                document.getElementById('articles-grid').innerHTML = '<div class="col-span-full text-center text-slate-400 py-10">記事がありません</div>';
                return;
            }

            // 検索時はヒーローセクションを表示しない、通常時は最初の記事をヒーローに
            if (skipHero) {
                document.getElementById('hero-section').classList.add('hidden');
                renderGrid(items, isCache);
            } else {
                const hero = items[0];
                const others = items.slice(1);
                renderHero(hero, isCache);
                renderGrid(others, isCache);
            }
        }

        function renderHero(item, isCache) {
            const section = document.getElementById('hero-section');
            section.classList.remove('hidden');
            
            const isBookmarked = bookmarks.some(b => b.id === item.id);
            const btnClass = isBookmarked ? "text-pink-500 bg-pink-50" : "text-slate-400 bg-white hover:bg-slate-100";

            section.innerHTML = `
                <div class="relative w-full h-[360px] md:h-[400px] rounded-3xl overflow-hidden shadow-xl group card-hover">
                    <img src="${item.imageUrl}" 
                         class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" 
                         alt="Hero Image"
                         onerror="this.src='https://images.unsplash.com/photo-1504711434969-e33886168f5c?auto=format&fit=crop&q=80&w=800';this.onerror=null;">
                    <div class="absolute inset-0 img-gradient flex flex-col justify-end p-6 md:p-10">
                        <div class="flex justify-between items-end">
                            <div class="text-white max-w-3xl">
                                <span class="inline-block bg-blue-600 text-white text-[10px] font-bold px-2 py-1 rounded mb-3">FEATURED</span>
                                <h2 class="text-2xl md:text-4xl font-bold leading-tight mb-3 drop-shadow-md">
                                    <a href="${item.link}" target="_blank" class="hover:underline decoration-2 underline-offset-4">${item.title}</a>
                                </h2>
                                <p class="text-slate-200 text-sm md:text-base line-clamp-2 md:w-2/3 mb-2">${item.description}</p>
                                <div class="text-xs text-slate-300 flex items-center gap-2">
                                    <i class="far fa-clock"></i> ${item.date}
                                </div>
                            </div>
                            <button onclick="toggleBookmark('${encodeURIComponent(JSON.stringify(item))}', this)" class="w-12 h-12 rounded-full ${isBookmarked ? 'bg-pink-500 text-white' : 'bg-white/20 text-white hover:bg-white/30'} backdrop-blur-md flex items-center justify-center transition-all shadow-lg active:scale-90">
                                <i class="${isBookmarked ? 'fas' : 'far'} fa-heart text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderGrid(items, isCache) {
            const grid = document.getElementById('articles-grid');
            grid.innerHTML = items.map((item, idx) => {
                const isBookmarked = bookmarks.some(b => b.id === item.id);
                const delay = isCache ? 0 : Math.min(idx * 50, 400);
                
                const itemStr = encodeURIComponent(JSON.stringify(item));

                return `
                <article class="bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 flex flex-col h-full card-hover border border-slate-100 fade-in-up" style="animation-delay: ${delay}ms">
                    <div class="relative h-48 overflow-hidden group">
                        <img src="${item.imageUrl}" 
                             class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                             loading="lazy" 
                             alt="Thumbnail"
                             onerror="this.src='https://images.unsplash.com/photo-1504711434969-e33886168f5c?auto=format&fit=crop&q=80&w=800';this.onerror=null;">
                        <div class="absolute inset-0 bg-black/10 group-hover:bg-black/0 transition-colors"></div>
                        <button onclick="toggleBookmark('${itemStr}', this)" class="absolute top-3 right-3 w-8 h-8 rounded-full ${isBookmarked ? 'bg-pink-500 text-white' : 'bg-white/90 text-slate-400 hover:text-pink-500'} shadow-sm flex items-center justify-center transition-all z-10 active:scale-90">
                            <i class="${isBookmarked ? 'fas' : 'far'} fa-heart"></i>
                        </button>
                    </div>
                    <a href="${item.link}" target="_blank" class="flex-1 p-5 flex flex-col group/text">
                        <div class="flex items-center gap-2 text-[10px] text-slate-400 mb-2 font-medium uppercase tracking-wide">
                            <i class="far fa-clock"></i> ${item.date}
                        </div>
                        <h3 class="font-bold text-lg leading-snug text-slate-800 mb-3 group-hover/text:text-blue-600 transition-colors line-clamp-3">
                            ${item.title}
                        </h3>
                        <p class="text-sm text-slate-500 leading-relaxed line-clamp-3 mt-auto">
                            ${item.description}
                        </p>
                    </a>
                </article>
            `}).join('');
        }

        /**
         * ブックマーク機能
         */
        function toggleBookmark(itemStr, btnElement) {
            event.preventDefault();
            event.stopPropagation();

            const item = JSON.parse(decodeURIComponent(itemStr));
            const index = bookmarks.findIndex(b => b.id === item.id);
            const icon = btnElement.querySelector('i');

            if (index === -1) {
                bookmarks.push(item);
                btnElement.classList.remove('bg-white/90', 'text-slate-400', 'hover:text-pink-500', 'bg-white/20', 'hover:bg-white/30');
                btnElement.classList.add('bg-pink-500', 'text-white');
                icon.classList.remove('far');
                icon.classList.add('fas');
                icon.style.transform = 'scale(1.4)';
                setTimeout(() => icon.style.transform = 'scale(1)', 200);
            } else {
                bookmarks.splice(index, 1);
                
                if (btnElement.parentElement.classList.contains('flex') && btnElement.parentElement.classList.contains('justify-end')) {
                    btnElement.classList.remove('bg-pink-500', 'text-white');
                    btnElement.classList.add('bg-white/20', 'text-white', 'hover:bg-white/30');
                } else {
                    btnElement.classList.remove('bg-pink-500', 'text-white');
                    btnElement.classList.add('bg-white/90', 'text-slate-400');
                }
                
                icon.classList.remove('fas');
                icon.classList.add('far');

                if (isShowingBookmarks) {
                    showBookmarks();
                }
            }

            localStorage.setItem('news_bookmarks', JSON.stringify(bookmarks));
            updateBookmarkCount();
        }

        function updateBookmarkCount() {
            const count = bookmarks.length;
            document.getElementById('bookmark-count').textContent = count;
        }

        /**
         * ユーティリティ
         */
        function refreshFeed() {
            if (currentFeedId === 'home') {
                selectHome(true);
            } else if (currentFeedId) {
                selectSource(currentFeedId, true);
            } else if (isShowingBookmarks) {
                showBookmarks();
            }
        }

        function saveCache(id, items) {
            localStorage.setItem(`rss_cache_${id}`, JSON.stringify({
                timestamp: Date.now(),
                items: items
            }));
        }

        function loadCache(id) {
            try { return JSON.parse(localStorage.getItem(`rss_cache_${id}`)); } catch(e){ return null; }
        }

        // 開始
        init();

    </script>
</body>
</html>
